<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="MySQL - 运维, zerollone">
    <meta name="description" content="日志错误日志是MySQL中最重要的日志之一，它记录了当mysqld启动和停止时，以及服务器在运行过程中发生任何严重错误时的相关信息。当数据库出现任何故障导致无法正常使用时，建议首先查看此日志。
该日志是默认开启的，默认存放目录&amp;#x2F;v">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="referrer" content="no-referrer-when-downgrade">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>MySQL - 运维 | zerollone</title>
    <link rel="icon" type="image/png" href="/favicon.png">
    


    <!-- bg-cover style     -->



<link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.min.css">
<link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
<link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
<link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
<link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
<link rel="stylesheet" type="text/css" href="/css/matery.css">
<link rel="stylesheet" type="text/css" href="/css/my.css">
<link rel="stylesheet" type="text/css" href="/css/dark.css" media="none" onload="if(media!='all')media='all'">




    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
    <link rel="stylesheet" href="/css/post.css">




    
        <link rel="stylesheet" type="text/css" href="/css/reward.css">
    



    <script src="/libs/jquery/jquery-3.6.0.min.js"></script>

<meta name="generator" content="Hexo 6.3.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head>


<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container_header">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">zerollone</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-book" style="zoom: 0.6;"></i>
      
      <span>区块链</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/categories/%E4%BB%A5%E5%A4%AA%E5%9D%8A">
          
          <span>以太坊</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/solidity">
          
          <span>solidity</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE">
          
          <span>区块链</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/%E5%AF%86%E7%A0%81%E5%AD%A6">
          
          <span>密码学</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-laptop-code" style="zoom: 0.6;"></i>
      
      <span>Java</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/categories/Java%E5%9F%BA%E7%A1%80">
          
          <span>Java基础</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/Spring">
          
          <span>Spring</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/SpringMVC">
          
          <span>SpringMVC</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/SpringBoot">
          
          <span>SpringBoot</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/Mybatis">
          
          <span>Mybatis</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/JavaPrj">
          
          <span>其他</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-database" style="zoom: 0.6;"></i>
      
      <span>工具</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/categories/git">
          
          <span>git</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/docker">
          
          <span>docker</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/maven">
          
          <span>maven</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-film" style="zoom: 0.6;"></i>
      
      <span>基础</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/categories/MySQL">
          
          <span>MySQL</span>
        </a>
      </li>
      
      <li>
        <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95">
          
          <span>数据结构与算法</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories/others" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>其他</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="" class="waves-effect waves-light">

      
      <i class="fas fa-list" style="zoom: 0.6;"></i>
      
      <span>类别</span>
      <i class="fas fa-chevron-down" aria-hidden="true" style="zoom: 0.6;"></i>
    </a>
    <ul class="sub-nav menus_item_child ">
      
      <li>
        <a href="/tags">
          
          <i class="fas fa-tags" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>标签</span>
        </a>
      </li>
      
      <li>
        <a href="/categories">
          
          <i class="fas fa-bookmark" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>类别</span>
        </a>
      </li>
      
      <li>
        <a href="/archives">
          
          <i class="fas fa-archive" style="margin-top: -20px; zoom: 0.6;"></i>
          
          <span>归类</span>
        </a>
      </li>
      
    </ul>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
  <li>
    <a href="javascript:;" class="waves-effect waves-light" onclick="switchNightMode()" title="深色/浅色模式" >
      <i id="sum-moon-icon" class="fas fa-sun" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">zerollone</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-book"></i>
			
			区块链
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/categories/%E4%BB%A5%E5%A4%AA%E5%9D%8A " style="margin-left:75px">
				  
		          <span>以太坊</span>
                  </a>
                </li>
              
                <li>

                  <a href="/categories/solidity " style="margin-left:75px">
				  
		          <span>solidity</span>
                  </a>
                </li>
              
                <li>

                  <a href="/categories/%E5%8C%BA%E5%9D%97%E9%93%BE " style="margin-left:75px">
				  
		          <span>区块链</span>
                  </a>
                </li>
              
                <li>

                  <a href="/categories/%E5%AF%86%E7%A0%81%E5%AD%A6 " style="margin-left:75px">
				  
		          <span>密码学</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-laptop-code"></i>
			
			Java
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/categories/Java%E5%9F%BA%E7%A1%80 " style="margin-left:75px">
				  
		          <span>Java基础</span>
                  </a>
                </li>
              
                <li>

                  <a href="/categories/Spring " style="margin-left:75px">
				  
		          <span>Spring</span>
                  </a>
                </li>
              
                <li>

                  <a href="/categories/SpringMVC " style="margin-left:75px">
				  
		          <span>SpringMVC</span>
                  </a>
                </li>
              
                <li>

                  <a href="/categories/SpringBoot " style="margin-left:75px">
				  
		          <span>SpringBoot</span>
                  </a>
                </li>
              
                <li>

                  <a href="/categories/Mybatis " style="margin-left:75px">
				  
		          <span>Mybatis</span>
                  </a>
                </li>
              
                <li>

                  <a href="/categories/JavaPrj " style="margin-left:75px">
				  
		          <span>其他</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-database"></i>
			
			工具
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/categories/git " style="margin-left:75px">
				  
		          <span>git</span>
                  </a>
                </li>
              
                <li>

                  <a href="/categories/docker " style="margin-left:75px">
				  
		          <span>docker</span>
                  </a>
                </li>
              
                <li>

                  <a href="/categories/maven " style="margin-left:75px">
				  
		          <span>maven</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-film"></i>
			
			基础
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/categories/MySQL " style="margin-left:75px">
				  
		          <span>MySQL</span>
                  </a>
                </li>
              
                <li>

                  <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95 " style="margin-left:75px">
				  
		          <span>数据结构与算法</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories/others" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			其他
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="javascript:;">
			
				<i class="fa-fw fas fa-list"></i>
			
			类别
			<span class="m-icon"><i class="fas fa-chevron-right"></i></span>
		</a>
            <ul  style="background:  ;" >
              
                <li>

                  <a href="/tags " style="margin-left:75px">
				  
				   <i class="fa fas fa-tags" style="position: absolute;left:50px" ></i>
			      
		          <span>标签</span>
                  </a>
                </li>
              
                <li>

                  <a href="/categories " style="margin-left:75px">
				  
				   <i class="fa fas fa-bookmark" style="position: absolute;left:50px" ></i>
			      
		          <span>类别</span>
                  </a>
                </li>
              
                <li>

                  <a href="/archives " style="margin-left:75px">
				  
				   <i class="fa fas fa-archive" style="position: absolute;left:50px" ></i>
			      
		          <span>归类</span>
                  </a>
                </li>
              
            </ul>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        
    </ul>
</div>


        </div>

        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('http://img.zerollone.top/00/mysql.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">MySQL - 运维</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/MySQL/">
                                <span class="chip bg-color">MySQL</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/mysql/" class="post-category">
                                mysql
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2023-09-24
                </div>
                

                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-check fa-fw"></i>更新日期:&nbsp;&nbsp;
                    2023-10-02
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    5k
                </div>
                

                
                <div class="info-break-policy">
                    <i class="far fa-clock fa-fw"></i>阅读时长:&nbsp;&nbsp;
                    18 分
                </div>
                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h2 id="日志"><a href="#日志" class="headerlink" title="日志"></a>日志</h2><p>错误日志是MySQL中最重要的日志之一，它记录了当mysqld启动和停止时，以及服务器在运行过程中发生任何严重错误时的相关信息。当数据库出现任何故障导致无法正常使用时，建议首先查看此日志。</p>
<p>该日志是默认开启的，默认存放目录&#x2F;var&#x2F;log&#x2F;，默认的日志文件名为 mysqld.log。查看日志位置:</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%log_error%'</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h2 id="二进制日志"><a href="#二进制日志" class="headerlink" title="二进制日志"></a>二进制日志</h2><p>二进制日志（BINLOG）记录了所有的DDL(数据定义语言）语句和DML(数据操纵语言）语句，但不包括数据查询（SELECT、SHOW)语句。</p>
<p><strong>作用</strong></p>
<ul>
<li>灾难时的数据恢复</li>
<li>MySQL的主从复制</li>
</ul>
<p>在MySQL8版本中，默认二进制日志是开启的，涉及的参数如下：</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%log_bin%'</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="日志格式"><a href="#日志格式" class="headerlink" title="日志格式"></a>日志格式</h4><p>MySQL服务器中提供了多种格式来记录二进制日志，具体格式及特点如下：</p>
<table>
<thead>
<tr>
<th>日志格式</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>statement</td>
<td>基于SQL语句的日志记录，记录的是SQL语句，对数据进行修改的SQL都会记录在日志中</td>
</tr>
<tr>
<td>row</td>
<td>基于行的日志记录，记录的是每一行的数据变更。（默认）</td>
</tr>
<tr>
<td>mixed</td>
<td>混合了statement和row两种格式，默认采用statement，在某些特殊情况下会自动切换成row进行记录</td>
</tr>
</tbody></table>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%binlog_format%'</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="日志查看"><a href="#日志查看" class="headerlink" title="日志查看"></a>日志查看</h4><p>由于日志是以二进制方式存储的，不能直接读取，需要通过二进制日志查询工具mysqlbinlog 来查看，具体语法:</p>
<pre class="line-numbers language-sql"><code class="language-sql">mysqlbinlog <span class="token punctuation">[</span>参数选项<span class="token punctuation">]</span> logFileName

<span class="token comment" spellcheck="true">-- 参数选项</span>
<span class="token operator">-</span><span class="token number">d</span>       指定数据库名称，只列出指定的数据库相关操作
<span class="token operator">-</span>o       忽略掉日志中的前n行命令
<span class="token operator">-</span>v       将行事件（数据变更）重构为SQL语句
<span class="token operator">-</span>w       将行事件（数据变更）重构为SQL语句，并输出注释信息
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="日志删除"><a href="#日志删除" class="headerlink" title="日志删除"></a>日志删除</h4><p>对于比较繁忙的业务系统，每天生成的binlog数据巨大，如果长时间不清除，将会占用大量磁盘空间。可以通过以下几种方式清理日志:</p>
<table>
<thead>
<tr>
<th>指令</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>reset master</td>
<td>删除全部binlog日志，删除之后日志编号将从binlog.000001重新开始</td>
</tr>
<tr>
<td>purge master logs to ‘binglog.****’</td>
<td>删除****编号之前的所有日志（不好含本身）</td>
</tr>
<tr>
<td>purge master logs before ‘yyyy-mm-dd hh24:mi:ss’</td>
<td>删除日志为’yyyy-mm-dd hh24:mi:ss’之前产生的所有日志</td>
</tr>
</tbody></table>
<p>也可以在mysql的配置文件中配置二进制日志的过期时间，设置了之后二进制日志过期会自动删除.</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%binlog_expire_logs_seconds%'</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
<h4 id="查询日志"><a href="#查询日志" class="headerlink" title="查询日志"></a>查询日志</h4><p>查询日志中记录了客户端的所有操作语句，而二进制日志不包含查询数据的SQL语句。默认情况下，查询日志是未开启的。如果需要开启查询日志，可以设置以下配置∶</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">-- 查看是否开启</span>
<span class="token keyword">show</span> variables <span class="token operator">like</span> <span class="token string">'%general%'</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p>修改MySQL的配置文件 &#x2F;etc&#x2F;my.cnf 文件，添加内容如下</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">-- 开启查询日志，可选值：0 表示关闭，1 表示开启</span>
general_log <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment" spellcheck="true">-- 设置日志的文件名，如果没有指定，默认的文件名为 host_name.log</span>
general_log_file <span class="token operator">=</span> mysql_query<span class="token punctuation">.</span>log
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h4 id="慢查询日志"><a href="#慢查询日志" class="headerlink" title="慢查询日志"></a>慢查询日志</h4><p>慢查询日志记录了所有执行时间超过参数long_query_time设置值并且扫描记录数不小于min_examined_row_limit的所有的SQL语句的日志，默认未开启。long_query_time默认为10秒，最小为0，精度可以到微秒。</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">-- 慢查询日志</span>
slow_query_log <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment" spellcheck="true">-- 执行时间参数</span>
long_query_time <span class="token operator">=</span> <span class="token number">2</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>默认情况下，不会记录管理语句，也不会记录不使用索引进行查找的查询。可以使用log_slow_admin_statements和log_queries_not_using_indexes进行更改，如下所述。</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">-- 记录执行较慢的管理语句</span>
log_slow_admin_statements <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment" spellcheck="true">-- 记录执行较慢的未使用索引的语句</span>
log_queries_not_using_indexes <span class="token operator">=</span> <span class="token number">1</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<h2 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h2><p>主从复制是指将主数据库的DDL和DML操作通过二进制日志传到从库服务器中，然后在从库上对这些日志重新执行（也叫重做)，从而使得主库（Master）和从库（Slave）的数据保持同步。</p>
<p>MySQL支持一台主库同时向多台从库进行复制，从库同时也可以作为其他从服务器的主库，实现链状复制。</p>
<blockquote>
<p>MySQL复制的优点不要包含三个方面：</p>
<ul>
<li>主库出现问题，可以快速切换到从库提供服务</li>
<li>实现读写分离，降低主库的访问压力</li>
<li>可以在从库中执行备份，以避免备份期间影响主库服务</li>
</ul>
</blockquote>
<p><em><strong>MySQL的主从复制原理如下：</strong></em><br><img src="http://img.zerollone.top/mysql/8.jpg"></p>
<p>从上图来看，复制分为三步：<br>1、Master主库在事务提交时，会把数据变更记录在二进制日志文件Binlog中。<br>2、从库读取主库的二进制日志文件Binlog，写入到从库的中继日志relay log中。<br>3、Slave重做中继日志中的事件，将改变反映它自己的数据</p>
<h4 id="主从复制具体操作"><a href="#主从复制具体操作" class="headerlink" title="主从复制具体操作"></a>主从复制具体操作</h4><ul>
<li><em><strong>主库配置</strong></em></li>
</ul>
<ol>
<li><p>修改配置文件 &#x2F;etc&#x2F;my.cnf</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">-- mysql服务id，保证整个集群环境中唯一，取值范围：1 ~ 2^32-1，默认为1</span>
server<span class="token operator">-</span>id <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment" spellcheck="true">-- 是否只读，1代表只读，0代表读写</span>
<span class="token keyword">read</span><span class="token operator">-</span>only <span class="token operator">=</span> <span class="token number">0</span>

<span class="token comment" spellcheck="true">-- 忽略的数据，指不需要同步的数据库</span>
<span class="token comment" spellcheck="true">--binlog-ignore-db = mysql</span>

<span class="token comment" spellcheck="true">-- 指定同步的数据库</span>
<span class="token comment" spellcheck="true">--binlog-do-db = db01</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>重启MySQL服务器</p>
<pre class="line-numbers language-sql"><code class="language-sql">systemctl restart mysqld
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>登录MySQL，创建远程连接的账户，并授予主从复制权限</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">-- 创建alice用户，并设置密码，该用户可在任意主机上连接该MySQL服务</span>
<span class="token keyword">create</span> <span class="token keyword">user</span> <span class="token string">'alice'</span>@'<span class="token operator">%</span><span class="token string">' identified with mysql_native_password by '</span>alice<span class="token number">.123</span>'<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 为'alice'@'%'用户分配主从复制权限</span>
<span class="token keyword">grant</span> <span class="token keyword">replication</span> slave <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> <span class="token string">'alice'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>通过指令，查看二进制日志坐标</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">show</span> master <span class="token keyword">status</span><span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 字段含义</span>
<span class="token comment" spellcheck="true">--      file：从哪个日志文件开始推送日志文件</span>
<span class="token comment" spellcheck="true">--      position：从日志文件的哪个位置开始推送日志</span>
<span class="token comment" spellcheck="true">--      binlog_ignore_log：指定不需要同步的数据库</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
<ul>
<li><em><strong>从库配置</strong></em></li>
</ul>
<ol>
<li><p>修改配置文件 &#x2F;etc&#x2F;my.cnf</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">-- mysql服务id，保证整个集群环境中唯一，取值范围：1 ~ 2^32-1，和主库不一样</span>
server<span class="token operator">-</span>id <span class="token operator">=</span> <span class="token number">2</span>

<span class="token comment" spellcheck="true">-- 是否只读，1代表只读，0代表读写</span>
<span class="token comment" spellcheck="true">-- 该项只针对普通用户，针对管理员用户设置应该是：super-read-only = 1</span>
<span class="token keyword">read</span><span class="token operator">-</span>only <span class="token operator">=</span> <span class="token number">1</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>重启MySQL服务器</p>
<pre class="line-numbers language-sql"><code class="language-sql">systemctl restart mysqld
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p>登录MySQL，设置主库配置</p>
<pre class="line-numbers language-sql"><code class="language-sql">change <span class="token keyword">replication</span> source <span class="token keyword">to</span> source_host<span class="token operator">=</span><span class="token string">'xx.xx'</span><span class="token punctuation">,</span>source_user<span class="token operator">=</span><span class="token string">'xxx'</span><span class="token punctuation">,</span>source_password<span class="token operator">=</span><span class="token string">'xxx'</span><span class="token punctuation">,</span>source_log_file<span class="token operator">=</span><span class="token string">'xxx'</span><span class="token punctuation">,</span>source_log_pos<span class="token operator">=</span>xxx<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 上述是8.0.23中的语法，如果mysql是8.0.23之前的版本，则执行下面的sql</span>
change master <span class="token keyword">to</span> master_host<span class="token operator">=</span><span class="token string">'xx.xx'</span><span class="token punctuation">,</span>master_user<span class="token operator">=</span><span class="token string">'xxx'</span><span class="token punctuation">,</span>master_password<span class="token operator">=</span><span class="token string">'xxx'</span><span class="token punctuation">,</span>master_log_file<span class="token operator">=</span><span class="token string">'xxx'</span><span class="token punctuation">,</span>master_log_pos<span class="token operator">=</span>xxx<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre>
<table>
<thead>
<tr>
<th>参数含义</th>
<th>8.0.23</th>
<th>8.0.23之前</th>
</tr>
</thead>
<tbody><tr>
<td>主库IP地址</td>
<td>source_host</td>
<td>master_host</td>
</tr>
<tr>
<td>连接主库的用户名</td>
<td>source_user</td>
<td>master_user</td>
</tr>
<tr>
<td>连接主库的密码</td>
<td>source_password</td>
<td>master_password</td>
</tr>
<tr>
<td>主库binlog日志文件名（主库show master status命令中的值）</td>
<td>source_log_file</td>
<td>master_log_file</td>
</tr>
<tr>
<td>主库binlog日志文件位置（主库show master status命令中的值）</td>
<td>source_log_pos</td>
<td>master_log_pos</td>
</tr>
</tbody></table>
</li>
<li><p>mysql服务中开启同步操作</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">start</span> replica<span class="token punctuation">;</span>  <span class="token comment" spellcheck="true">-- 8.0.22之后</span>
<span class="token keyword">start</span> slave<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">-- 8.0.22之前</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>查看主从同步状态</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">show</span> replice <span class="token keyword">status</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">-- 8.0.22之后</span>
<span class="token keyword">show</span> slave <span class="token keyword">status</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">-- 8.0.22之前</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ol>
<h2 id="分库分表"><a href="#分库分表" class="headerlink" title="分库分表"></a>分库分表</h2><p>随着互联网及移动互联网的发展，应用系统的数据量也是成指数式增长，若采用单数据库进行数据存储，存在以下性能瓶颈：</p>
<ol>
<li>IO瓶颈：热点数据太多，数据库缓存不足，产生大量磁盘IO，效率较低。请求数据太多带宽不够，网络IO瓶颈。</li>
<li>CPU瓶颈：排序、分组、连接查询、聚合统计等SQL会耗费大量的CPU资源，请求数太多，CPU出现瓶颈。</li>
</ol>
<p><strong>解决上述问题采用分库分表的思想：</strong><br>分库分表的中心思想都是将数据分散存储，使得单一数据库&#x2F;表的数据量变小来缓解单一数据库的性能问题，从而达到提升数据库性能的目的。</p>
<h4 id="拆分策略"><a href="#拆分策略" class="headerlink" title="拆分策略"></a>拆分策略</h4><p>拆分分为垂直拆分和水平拆分两种，垂直拆分包括垂直分库和垂直分表；水平拆分包括水平分库和水平分表。</p>
<ul>
<li><p><strong>垂直拆分</strong></p>
<blockquote>
<p><strong>垂直分库：</strong> 以表为依据，根据业务将不同表拆分到不同库中。其特点有：</p>
<ul>
<li>每个库的表结构都不一样</li>
<li>每个库的数据也不一样</li>
<li>所有库的并集是全量数据</li>
</ul>
<hr>
<p><strong>垂直分表：</strong> 以字段为依据，根据字段属性将不同字段拆分到不同表中。其特点有：</p>
<ul>
<li>每个表的结构都不一样</li>
<li>每个表的数据也不一样，一般通过一列（主键&#x2F;外键）关联</li>
<li>所有表的并集是全量数据</li>
</ul>
</blockquote>
</li>
<li><p><strong>水平拆分</strong></p>
<blockquote>
<p><strong>水平分库：</strong> 以字段为依据，按照一定策略，将一个库的数据拆分到多个库中（可用理解为将库中多个表中的数据进行分散存储在多个服务器中）。其特点有：</p>
<ul>
<li>每个库的表结构都一样</li>
<li>每个库的数据不一样</li>
<li>所有库的并集是全量数据</li>
</ul>
<hr>
<p><strong>水平分表：</strong> 以字段为依据，按照一定策略，将一个表的数据拆分到多个表中。其特点有：</p>
<ul>
<li>每个表的结构都一样</li>
<li>每个表的数据不一样</li>
<li>所有表的并集是全量数据</li>
</ul>
</blockquote>
</li>
</ul>
<h5 id="实现技术"><a href="#实现技术" class="headerlink" title="实现技术"></a>实现技术</h5><p>shardingJDBC：基于AOP原理，在应用程序中对本地执行的SQL进行拦截，解析，改写，路由处理。需要自行编码配置实现，只支持Java语言，性能较高</p>
<p>MyCat：数据库分库分表中间件，不用调整代码即可实现分库分表，支持多种语言，性能不及前者</p>
<h4 id="MyCat概述"><a href="#MyCat概述" class="headerlink" title="MyCat概述"></a>MyCat概述</h4><p>Mycat是开源的、活跃的、基于Java语言编写的MySQL数据库中间件。可以像使用mysql一样来使用mycat，对于开发人员来说根本感觉不到mycat的存在。</p>
<p>其优点有：性能可靠稳定、强大的技术团队、体系完善、社区活跃<br>MyCat的结构如下，其只包括逻辑结构<br><img src="http://img.zerollone.top/mysql/11.jpg"></p>
<h4 id="MyCat入门"><a href="#MyCat入门" class="headerlink" title="MyCat入门"></a>MyCat入门</h4><p>1、分片配置（schema.xml）<br><img src="http://img.zerollone.top/mysql/12.jpg"></p>
<p>2、配置mycat的用户及用户的权限信息（server.xml）<br><img src="http://img.zerollone.top/mysql/13.jpg"></p>
<p>3、启动mycat</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">-- 切换到mycat的安装目录，执行如下指令，启动mycat</span>

<span class="token comment" spellcheck="true">-- 启动</span>
bin<span class="token operator">/</span>mycat <span class="token keyword">start</span>

<span class="token comment" spellcheck="true">-- 停止</span>
bin<span class="token operator">/</span>mycat stop

<span class="token comment" spellcheck="true">-- mycat启动之后，占用端口号8066</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>4、连接mycat</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">-- 通过如下指令，连接并登录mycat</span>
mysql <span class="token operator">-</span>h <span class="token number">192.168</span><span class="token punctuation">.</span><span class="token number">0.1</span> <span class="token operator">-</span>P <span class="token number">8066</span> <span class="token operator">-</span>uroot <span class="token operator">-</span>p123456
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<p><em><strong>配置mycat之后，插入和查询等SQL语句都在mycat中执行，不需要去操作分库分表后的数据库服务器，在mycat中会根据相应的规则将数据插入到对应的数据库服务器中</strong></em></p>
<h4 id="MyCat配置"><a href="#MyCat配置" class="headerlink" title="MyCat配置"></a>MyCat配置</h4><h5 id="schema-xml"><a href="#schema-xml" class="headerlink" title="schema.xml"></a>schema.xml</h5><p>schema.xml 作为 mycat 中最重要的配置文件之一，涵盖了mycat的逻辑库、逻辑表、分片规则、分片节点及数据源的配置。</p>
<p>主要包含以下三组标签：</p>
<ul>
<li><p>schema标签<br><img src="http://img.zerollone.top/mysql/14.jpg"></p>
<p>  schema标签用于定义MyCat实例中的逻辑库，一个MyCat实例中，可以有多个逻辑库，可以通过schema标签来划分不同的逻辑库。<br>  MyCat中的逻辑库的概念，等同于My5QL中的database概念，需要操作某个逻辑库下的表时，也需要切换逻辑库(use xxx)。</p>
<pre><code>  核心属性
      name：指定自定义的逻辑库库名
      checkSQLschema：在sql语句操作时指定了数据库名称，执行时是否自动去除；true表示自动去除，false表示不自动去除
      sqlMaxLimit：如果未指定limit进行查询，列表查询模式查询多少条记录
</code></pre>
<p>  table标签定义了MyCat中逻辑库schema下的逻辑表，所有需要拆分的表都需要在table标签中定义。</p>
<pre><code>  核心属性
      name：定义逻辑表表名，在该逻辑库下唯一
      dataNode：定义逻辑表所属的dataNode，该属性需要与dataNode标签中name对应，多个dataNode逗号分隔
      rule：分片规则的名字，分配规则名字是在rule.xml中定义的
      primaryKey：逻辑表对应真实表的主键
      type：逻辑表的类型，目前逻辑表只有全局表和普通表，如果未配置，就是普通表，全局表配置未global
</code></pre>
</li>
<li><p>datanode标签<br><img src="http://img.zerollone.top/mysql/15.jpg"><br>dataNode标签中定义了mycat中的数据节点，也就是通常说的数据分片，一个dataNode标签就是一个独立的数据分片</p>
<pre><code>  核心属性
      name：定义数据节点名称
      dataHost：数据库实例主机名称，引用自dataHost标签中的name属性
      database：定义分片所属数据库
</code></pre>
</li>
<li><p>datahost标签<br><img src="http://img.zerollone.top/mysql/16.jpg"><br>该标签在mycat逻辑库中作为底层标签存在，直接定义了具体的数据库实例、读写分离、心跳语句。</p>
<pre><code>  核心属性
      name：唯一标识，供上层标签使用
      maxCon/minCon：最大连接数/最小连接数
      balance：负载均衡策略，取值0，1，2，3
      writeType：写操作分发方式（0：写操作转发到第一个writeHost，第一个挂了，切换到第二个；1：写操作随机分发到配置的writeHost）
      dbDriver：数据库驱动，支持native(mysql5.6 5.7)、jdbc(mysql8.0)
</code></pre>
</li>
</ul>
<hr>
<h5 id="rule-xml"><a href="#rule-xml" class="headerlink" title="rule.xml"></a>rule.xml</h5><p>rule.xml中定义所有拆分表的规则，在使用过程中可以灵活的使用分片算法，或者对同一个分片算法使用不同的参数，它让分片过程可配置化。主要包含两类标签： tableRule、Function。</p>
<p><img src="http://img.zerollone.top/mysql/17.jpg"></p>
<h5 id="server-xml"><a href="#server-xml" class="headerlink" title="server.xml"></a>server.xml</h5><p>server.xml配置文件包含了mycat的系统配置信息，主要有两个重要的标签：system、user</p>
<ul>
<li><p>system标签，对应的系统配置项及其含义，参考资料<br><img src="http://img.zerollone.top/mysql/18.jpg"></p>
</li>
<li><p>user标签<br><img src="http://img.zerollone.top/mysql/19.jpg"></p>
</li>
</ul>
<h4 id="MyCat分片（分库分表）"><a href="#MyCat分片（分库分表）" class="headerlink" title="MyCat分片（分库分表）"></a>MyCat分片（分库分表）</h4><ul>
<li><p>垂直分库<br>配置<br><img src="http://img.zerollone.top/mysql/20.jpg"><br><img src="http://img.zerollone.top/mysql/21.jpg"><br>测试<br><img src="http://img.zerollone.top/mysql/22.jpg"><br>第二条SQL语句将会报错，因为所使用的省市区表存在另一个数据库中。解决方法是将这些表配置为全局表。在业务中，这些表属于数据字典表，在多个业务模块中都可能会遇到，可以将其设置为全局表，利于业务操作<br><img src="http://img.zerollone.top/mysql/23.jpg"></p>
</li>
<li><p>水平分表<br><img src="http://img.zerollone.top/mysql/24.jpg"></p>
</li>
<li><p>分片规则 – 范围<br>根据指定的字段及其配置的范围与数据节点的对应情况，来决定该数据属于哪一个分片<br><img src="http://img.zerollone.top/mysql/25.jpg"></p>
</li>
<li><p>分片规则 – 取模<br>根据指定的字段值与节点数量进行求模运算，根据运算结果，来决定该数据属于哪一个分片<br><img src="http://img.zerollone.top/mysql/26.jpg"></p>
</li>
<li><p>分片规则 – 一致性hash<br>所谓一致性哈希，相同的哈希因子计算值总是被划分到相同的分区表中，不会因为分区节点的增加而改变原来数据的分区位置<br><img src="http://img.zerollone.top/mysql/27.jpg"></p>
</li>
<li><p>分片规则 – 枚举<br>通过在配置文件中配置可能的枚举值，指定数据分布到不同数据节点上，本规则适用于按照省份、性别、状态拆分数据等业务。<br><img src="http://img.zerollone.top/mysql/28.jpg"></p>
</li>
<li><p>分片规则 – 应用指定<br>运行阶段由应用自主决定路由到那个分片，直接根据字符子串（必须是数字）计算分片号<br><img src="http://img.zerollone.top/mysql/29.jpg"></p>
</li>
<li><p>分片规则 – 固定分片hash算法<br>该算法类似于十进制的求模运算，但是为二进制的操作，例如，取id的二进制低10位与1111111111进行位&amp;运算，运算结果的范围是 0000000000 ~ 1111111111，即0~1023</p>
<pre><code>  特点
      如果是求模，连续的值，分别分配到各个不同的分片，但是此算法会将连续的值可能分配到相同的分片，降低事务处理的难度
      可以均匀分配，也可以非均匀分配
      分片字段必须为数字类型
</code></pre>
<p>  <img src="http://img.zerollone.top/mysql/30.jpg"></p>
</li>
<li><p>分片规则 – 字符串hash解析<br>截取字符串中的指定位置的子字符串，进行hash算法，算出分片<br><img src="http://img.zerollone.top/mysql/31.jpg"></p>
</li>
<li><p>分片规则 – 按（天）日期分片<br><img src="http://img.zerollone.top/mysql/32.jpg"></p>
</li>
<li><p>分片规则 – 自然月<br>使用场景为按照月份来分片，每个自然月为一个分片<br><img src="http://img.zerollone.top/mysql/33.jpg"></p>
</li>
</ul>
<h2 id="读写分离"><a href="#读写分离" class="headerlink" title="读写分离"></a>读写分离</h2><p>读写分离，简单地说是把对数据库的读和写操作分开，以对应不同的数据库服务器。主数据库提供写操作，从数据库提供读操作，这样能有效地减轻单台数据库的压力。</p>
<p>通过MyCat即可轻易实现上述功能，不仅可以支持MySQL，也可以支持Oracle和SQL Server。</p>
<h4 id="一主一从读写分离"><a href="#一主一从读写分离" class="headerlink" title="一主一从读写分离"></a>一主一从读写分离</h4><p>MyCat控制后台数据库的读写分离和负载均衡由schema.xml文件datahost标签的balance属性控制。<br><img src="http://img.zerollone.top/mysql/9.jpg"></p>
<p><strong>其中balance负责负载均衡策略，目前取值有4种</strong></p>
<table>
<thead>
<tr>
<th>参数值</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>0</td>
<td>不开启读写分离机制，所有读操作都发送到当前可用的writeHost上</td>
</tr>
<tr>
<td>1</td>
<td>全部的readHost与备用的writeHost都参与select语句的负载均衡（主要针对双主双从）</td>
</tr>
<tr>
<td>2</td>
<td>所有的读写操作都随机在writeHost，readHost上分发</td>
</tr>
<tr>
<td>3</td>
<td>所有的读请求随机分发到writeHost对应的readHost上执行，writeHost不负担读压力</td>
</tr>
</tbody></table>
<h4 id="双主双从读写分离"><a href="#双主双从读写分离" class="headerlink" title="双主双从读写分离"></a>双主双从读写分离</h4><p>一个主机 Master1用于处理所有写请求，它的从机Slave1和另一台主机Master2还有它的从机slave2负责所有读请求。当Master1主机宕机后，Master2主机负责写请求，Master1 、Master2互为备机。</p>
<ul>
<li><em><strong>主库 1 配置</strong></em></li>
</ul>
<ol>
<li><p>修改配置文件 &#x2F;etc&#x2F;my.cnf</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">-- mysql服务id，保证整个集群环境中唯一，取值范围：1 ~ 2^32-1，默认为1</span>
server<span class="token operator">-</span>id <span class="token operator">=</span> <span class="token number">1</span>

<span class="token comment" spellcheck="true">-- 指定同步的数据库</span>
binlog<span class="token operator">-</span><span class="token keyword">do</span><span class="token operator">-</span><span class="token number">db</span> <span class="token operator">=</span> <span class="token number">db01</span>
binlog<span class="token operator">-</span><span class="token keyword">do</span><span class="token operator">-</span><span class="token number">db</span> <span class="token operator">=</span> <span class="token number">db02</span>

<span class="token comment" spellcheck="true">-- 在作为从数据库的时候，有写入操作也要更新二进制日志文件</span>
log<span class="token operator">-</span>slave<span class="token operator">-</span>updates
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>重启MySQL服务器</p>
<pre class="line-numbers language-sql"><code class="language-sql">systemctl restart mysqld
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ol>
<ul>
<li><em><strong>主库 2 配置</strong></em></li>
</ul>
<ol>
<li><p>修改配置文件 &#x2F;etc&#x2F;my.cnf</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">-- mysql服务id，保证整个集群环境中唯一，取值范围：1 ~ 2^32-1，默认为1</span>
server<span class="token operator">-</span>id <span class="token operator">=</span> <span class="token number">3</span>

<span class="token comment" spellcheck="true">-- 指定同步的数据库</span>
binlog<span class="token operator">-</span><span class="token keyword">do</span><span class="token operator">-</span><span class="token number">db</span> <span class="token operator">=</span> <span class="token number">db01</span>
binlog<span class="token operator">-</span><span class="token keyword">do</span><span class="token operator">-</span><span class="token number">db</span> <span class="token operator">=</span> <span class="token number">db02</span>

<span class="token comment" spellcheck="true">-- 在作为从数据库的时候，有写入操作也要更新二进制日志文件</span>
log<span class="token operator">-</span>slave<span class="token operator">-</span>updates
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
</li>
<li><p>重启MySQL服务器</p>
<pre class="line-numbers language-sql"><code class="language-sql">systemctl restart mysqld
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ol>
<ul>
<li><p><em><strong>两台主库创建账户并授权</strong></em></p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">-- 创建alice用户，并设置密码，该用户可在任意主机上连接该MySQL服务</span>
<span class="token keyword">create</span> <span class="token keyword">user</span> <span class="token string">'alice'</span>@'<span class="token operator">%</span><span class="token string">' identified with mysql_native_password by '</span>alice<span class="token number">.123</span>'<span class="token punctuation">;</span>

<span class="token comment" spellcheck="true">-- 为'alice'@'%'用户分配主从复制权限</span>
<span class="token keyword">grant</span> <span class="token keyword">replication</span> slave <span class="token keyword">on</span> <span class="token operator">*</span><span class="token punctuation">.</span><span class="token operator">*</span> <span class="token keyword">to</span> <span class="token string">'alice'</span><span class="token variable">@'%'</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<p>  通过指令，查看两台主库的二进制日志坐标</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">show</span> master <span class="token keyword">status</span><span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li><p><em><strong>主库 1 的从库配置</strong></em></p>
</li>
</ul>
<ol>
<li><p>修改配置文件 &#x2F;etc&#x2F;my.cnf</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">-- mysql服务id，保证整个集群环境中唯一，取值范围：1 ~ 2^32-1，和主库不一样</span>
server<span class="token operator">-</span>id <span class="token operator">=</span> <span class="token number">2</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>重启MySQL服务器</p>
<pre class="line-numbers language-sql"><code class="language-sql">systemctl restart mysqld
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ol>
<ul>
<li><em><strong>主库 2 的从库配置</strong></em></li>
</ul>
<ol>
<li><p>修改配置文件 &#x2F;etc&#x2F;my.cnf</p>
<pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">-- mysql服务id，保证整个集群环境中唯一，取值范围：1 ~ 2^32-1，和主库不一样</span>
server<span class="token operator">-</span>id <span class="token operator">=</span> <span class="token number">4</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
<li><p>重启MySQL服务器</p>
<pre class="line-numbers language-sql"><code class="language-sql">systemctl restart mysqld
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
</ol>
<ul>
<li><em><strong>两台从库配置其关联的主库</strong></em></li>
</ul>
<ol>
<li>登录MySQL，设置主库配置，两台从库都进行对应的设置<pre class="line-numbers language-sql"><code class="language-sql">change <span class="token keyword">replication</span> source <span class="token keyword">to</span> source_host<span class="token operator">=</span><span class="token string">'xx.xx'</span><span class="token punctuation">,</span>source_user<span class="token operator">=</span><span class="token string">'xxx'</span><span class="token punctuation">,</span>source_password<span class="token operator">=</span><span class="token string">'xxx'</span><span class="token punctuation">,</span>source_log_file<span class="token operator">=</span><span class="token string">'xxx'</span><span class="token punctuation">,</span>source_log_pos<span class="token operator">=</span>xxx<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre>
</li>
<li>启动两台从库的主从复制，并查看从库的状态<pre class="line-numbers language-sql"><code class="language-sql"><span class="token keyword">start</span> slave<span class="token punctuation">;</span>

<span class="token keyword">show</span> slave <span class="token keyword">status</span>\G<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
</li>
</ol>
<ul>
<li><em><strong>两台主库相互复制</strong></em><pre class="line-numbers language-sql"><code class="language-sql"><span class="token comment" spellcheck="true">-- 主库相互作为对方的从库</span>
change <span class="token keyword">replication</span> source <span class="token keyword">to</span> source_host<span class="token operator">=</span><span class="token string">'xx.xx'</span><span class="token punctuation">,</span>source_user<span class="token operator">=</span><span class="token string">'xxx'</span><span class="token punctuation">,</span>source_password<span class="token operator">=</span><span class="token string">'xxx'</span><span class="token punctuation">,</span>source_log_file<span class="token operator">=</span><span class="token string">'xxx'</span><span class="token punctuation">,</span>source_log_pos<span class="token operator">=</span>xxx<span class="token punctuation">;</span>
<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
</li>
</ul>
<hr>
<h4 id="读写分离-1"><a href="#读写分离-1" class="headerlink" title="读写分离"></a>读写分离</h4><p>MyCat控制后台数据库的读写分离和负载均衡由schema.xml文件datahost标签的balance属性控制，通过writeType及switchType来完成失败自动切换的。<br><img src="http://img.zerollone.top/mysql/10.jpg"></p>
<p><strong>dataHost标签中所加的参数及其含义</strong></p>
<blockquote>
<p><strong>balance &#x3D; “1”</strong><br>代表全部的readHost与stand by writeHost参与select语句的负载均衡，简单的说，当双主双从模式(M1-&gt;S1，M2-&gt;S2，并且M1与M2互为主备)，正常情况下，M2，S1，S2都参与select语句的负载均衡</p>
<p><strong>writeType</strong><br>0：写操作都转发到第1台writeHost，writeHost1挂了，会切换到writeHost2上<br>1：所有的写操作都随机地发送到配置的writeHost上;</p>
<p><strong>switchType</strong><br>-1：不自动切换<br> 1：自动切换</p>
</blockquote>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">zerollone</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://zerollone.top/edf0.html">http://zerollone.top/edf0.html</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">zerollone</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/MySQL/">
                                    <span class="chip bg-color">MySQL</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/babe.html">
                    <div class="card-image">
                        
                        <img src="http://img.zerollone.top/00/ds.jpg" class="responsive-img" alt="稀疏数组">
                        
                        <span class="card-title">稀疏数组</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2023-09-24
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/" class="post-category">
                                    数据结构与算法
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E4%B8%8E%E7%AE%97%E6%B3%95/">
                        <span class="chip bg-color">数据结构与算法</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/fb0b.html">
                    <div class="card-image">
                        
                        <img src="http://img.zerollone.top/00/mysql.jpg" class="responsive-img" alt="MySQL - 进阶">
                        
                        <span class="card-title">MySQL - 进阶</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2023-09-24
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/mysql/" class="post-category">
                                    mysql
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/MySQL/">
                        <span class="chip bg-color">MySQL</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>



<!-- 代码语言 -->


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>



    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="/libs/aplayer/Meting.min.js"></script>

    

    <div class="container row center-align"
         style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2023</span>
            
            <a href="/about" target="_blank">zerollone</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            
            <br>
            
                &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                        class="white-color">125.2k</span>
            
            
            
            
                <span id="busuanzi_container_site_pv" style='display:none'>
                &nbsp;|&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;
                    <span id="busuanzi_value_site_pv" class="white-color"></span>
            </span>
            
            
                <span id="busuanzi_container_site_uv" style='display:none'>
                &nbsp;|&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;
                    <span id="busuanzi_value_site_uv" class="white-color"></span>
            </span>
            
            <br>

            <!-- 运行天数提醒. -->
            
                <span id="sitetime"> Loading ...</span>
                <script>
                    var calcSiteTime = function () {
                        var seconds = 1000;
                        var minutes = seconds * 60;
                        var hours = minutes * 60;
                        var days = hours * 24;
                        var years = days * 365;
                        var today = new Date();
                        var startYear = "2023";
                        var startMonth = "4";
                        var startDate = "6";
                        var startHour = "8";
                        var startMinute = "1";
                        var startSecond = "30";
                        var todayYear = today.getFullYear();
                        var todayMonth = today.getMonth() + 1;
                        var todayDate = today.getDate();
                        var todayHour = today.getHours();
                        var todayMinute = today.getMinutes();
                        var todaySecond = today.getSeconds();
                        var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                        var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                        var diff = t2 - t1;
                        var diffYears = Math.floor(diff / years);
                        var diffDays = Math.floor((diff / days) - diffYears * 365);
                        var diffHours = Math.floor((diff / hours) - diffDays * 24 - diffYears * 365 * 24);
                        var diffMinutes = Math.floor((diff / minutes) - diffHours * 60 - diffDays * 24 * 60 - - diffYears * 365 * 24 * 60);

                        // 区分是否有年份.
                        var language = 'zh-CN';
                        if (startYear === String(todayYear)) {
                            document.getElementById("year").innerHTML = todayYear;
                            var daysTip = 'This site has been running for ' + diffDays + ' days';
                            if (language === 'zh-CN') {
                                daysTip = '本站已运行 ' + diffDays + ' 天 ' + diffHours + " 小时 " + diffMinutes + " 分钟";
                            } else if (language === 'zh-HK') {
                                daysTip = '本站已運行 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = daysTip;
                        } else {
                            document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                            var yearsAndDaysTip = 'This site has been running for ' + diffYears + ' years and '
                                + diffDays + ' days';
                            if (language === 'zh-CN') {
                                yearsAndDaysTip = '本站已运行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            } else if (language === 'zh-HK') {
                                yearsAndDaysTip = '本站已運行 ' + diffYears + ' 年 ' + diffDays + ' 天';
                            }
                            document.getElementById("sitetime").innerHTML = yearsAndDaysTip;
                        }
                    }

                    calcSiteTime();
                </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link ">
    <a href="https://github.com/zerollone" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:2294869408@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=2294869408" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 2294869408" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>









    <a href=" " class="tooltipped" target="_blank" data-tooltip="微信联系我：zerollone" data-position="top" data-delay="50">
        <i class="fas fa-comments"></i>
    </a>
</div>
    </div>
</footer>

<div class="progress-bar"></div>



<script>
    $(document).ready(function () {

        var int = setInterval(fixCount, 50);  // 50ms周期检测函数
        var pvcountOffset = -53648600;  // 初始化首次数据
        var uvcountOffset = -31135211;

        function fixCount() {
            if (document.getElementById("busuanzi_container_site_pv").style.display != "none") {
                $("#busuanzi_value_site_pv").html(parseInt($("#busuanzi_value_site_pv").html()) + pvcountOffset);
                clearInterval(int);
            }
            if ($("#busuanzi_container_site_pv").css("display") != "none") {
                $("#busuanzi_value_site_uv").html(parseInt($("#busuanzi_value_site_uv").html()) + uvcountOffset); // 加上初始数据 
                clearInterval(int); // 停止检测
            }
        }
    });
</script>

    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 白天和黑夜主题 -->
<div class="stars-con">
    <div id="stars"></div>
    <div id="stars2"></div>
    <div id="stars3"></div>  
</div>

<script>
    function switchNightMode() {
        $('<div class="Cuteen_DarkSky"><div class="Cuteen_DarkPlanet"></div></div>').appendTo($('body')),
        setTimeout(function () {
            $('body').hasClass('DarkMode') 
            ? ($('body').removeClass('DarkMode'), localStorage.setItem('isDark', '0'), $('#sum-moon-icon').removeClass("fa-sun").addClass('fa-moon')) 
            : ($('body').addClass('DarkMode'), localStorage.setItem('isDark', '1'), $('#sum-moon-icon').addClass("fa-sun").removeClass('fa-moon')),
            
            setTimeout(function () {
            $('.Cuteen_DarkSky').fadeOut(1e3, function () {
                $(this).remove()
            })
            }, 2e3)
        })
    }
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>

	

    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    

    
    
    

    <!-- 雪花特效 -->
    

    <!-- 鼠标星星特效 -->
    

     
        <script src="https://ssl.captcha.qq.com/TCaptcha.js"></script>
        <script src="/libs/others/TencentCaptcha.js"></script>
        <button id="TencentCaptcha" data-appid="xxxxxxxxxx" data-cbfn="callback" type="button" hidden></button>
    

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    

    

    

    <!--腾讯兔小巢-->
    
    
    <script type="text/javascript" color="0,0,255"
        pointColor="0,0,255" opacity='0.7'
        zIndex="-1" count="99"
        src="/libs/background/canvas-nest.js"></script>
    

    
    
    <script type="text/javascript" size="150" alpha='0.6'
        zIndex="-1" src="/libs/background/ribbon-refresh.min.js" async="async"></script>
    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
